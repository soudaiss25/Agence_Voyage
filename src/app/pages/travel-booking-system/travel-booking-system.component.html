<!-- PAGE 1: PREFERENCES -->
<div *ngIf="currentPage === 'preferences'" class="container-fluid min-vh-100" style="background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%)">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="text-center text-white mb-5">
          <h1 class="display-4 fw-bold mb-3">Votre Voyage Id√©al</h1>
          <p class="lead">Dites-nous vos pr√©f√©rences et nous vous proposerons le voyage parfait</p>
        </div>

        <div class="card shadow-lg border-0" style="border-radius: 20px">
          <div class="card-body p-5">
            
            <!-- Messages -->
            <div *ngIf="errorMessage" class="alert alert-danger mb-4" role="alert">
              <button type="button" class="btn-close" aria-label="Close" (click)="clearMessages()"></button>
              {{ errorMessage }}
            </div>

            <div *ngIf="successMessage && !errorMessage" class="alert alert-success mb-4" role="alert">
              <button type="button" class="btn-close" aria-label="Close" (click)="clearMessages()"></button>
              {{ successMessage }}
            </div>

            <!-- Spinner de chargement -->
            <div *ngIf="isLoading" class="text-center mb-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
              </div>
              <p class="mt-2">G√©n√©ration de vos recommandations personnalis√©es...</p>
            </div>

            <div class="row g-4" [style.opacity]="isLoading ? '0.5' : '1'">
              <!-- Climat -->
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark mb-3">
                  üå§Ô∏è Climat pr√©f√©r√© *
                </label>
                <div class="d-grid gap-2">
                  <div *ngFor="let climat of climatOptions" class="form-check">
                    <input 
                      class="form-check-input" 
                      type="radio" 
                      name="climat" 
                      [id]="climat"
                      [value]="climat"
                      [checked]="preferences.climat === climat"
                      (change)="onClimatChange(climat)"
                      [disabled]="isLoading"
                    />
                    <label class="form-check-label" [for]="climat">{{climat}}</label>
                  </div>
                </div>
              </div>

              <!-- Type de Voyage -->
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark mb-3">
                  üéØ Type de voyage *
                </label>
                <select 
                  class="form-select"
                  [value]="preferences.typeVoyage_id"
                  (change)="onTypeVoyageChange($event)"
                  [disabled]="isLoading"
                >
                  <option value="0">Choisir un type</option>
                  <option *ngFor="let type of typesVoyage" [value]="type.id">
                    {{type.libelle}}
                  </option>
                </select>
              </div>

              <!-- Langue -->
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark mb-3">
                  üó£Ô∏è Langue parl√©e *
                </label>
                <select 
                  class="form-select"
                  [value]="preferences.langueParlee"
                  (change)="onLanguageChange($event)"
                  [disabled]="isLoading"
                >
                  <option value="">Choisir une langue</option>
                  <option *ngFor="let lang of languageOptions" [value]="lang.value">
                    {{lang.label}}
                  </option>
                </select>
              </div>

              <!-- Budget -->
              <div class="col-md-6">
                <label class="form-label fw-bold text-dark mb-3">
                  üí∞ Budget *
                </label>
                <select 
                  class="form-select"
                  [value]="preferences.budget"
                  (change)="onBudgetChange($event)"
                  [disabled]="isLoading"
                >
                  <option value="">Choisir un budget</option>
                  <option *ngFor="let budget of budgetOptions" [value]="budget.value">
                    {{budget.label}}
                  </option>
                </select>
              </div>

              <!-- Activit√© principale -->
              <div class="col-12">
                <label class="form-label fw-bold text-dark mb-3">
                  üé® Activit√© principale pr√©f√©r√©e *
                </label>
                <div class="row">
                  <div *ngFor="let activite of activiteOptions" class="col-6 col-md-4">
                    <div class="form-check">
                      <input 
                        class="form-check-input" 
                        type="radio" 
                        name="activite"
                        [id]="activite"
                        [value]="activite"
                        [checked]="preferences.activite === activite"
                        (change)="onActiviteChange(activite)"
                        [disabled]="isLoading"
                      />
                      <label class="form-check-label" [for]="activite">{{activite}}</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="text-center mt-5">
              <button 
                class="btn btn-lg px-5 py-3 text-white fw-bold"
                style="background-color: #0d6efd; border-radius: 50px; border: none; box-shadow: 0 8px 25px rgba(13, 110, 253, 0.3)"
                (click)="saveAndGenerateRecommendations()"
                [disabled]="isLoading"
              >
                <span *ngIf="!isLoading">Voir mes recommandations ‚û§</span>
                <span *ngIf="isLoading">
                  <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                  G√©n√©ration en cours...
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PAGE 2: RECOMMENDATIONS -->
<div *ngIf="currentPage === 'recommendations'" class="container-fluid min-vh-100" style="background-color: #f8f9ff">
  <div class="container py-5">
    <div class="text-center mb-5">
      <h1 class="display-4 fw-bold mb-3" style="color: #0d6efd">
        üéØ Nos Recommandations Pour Vous
      </h1>
      <p class="lead text-muted">Bas√©es sur vos pr√©f√©rences personnalis√©es</p>
      
      <!-- Messages sur la page des recommandations -->
      <div *ngIf="successMessage" class="alert alert-success mx-auto" style="max-width: 600px;" role="alert">
        {{ successMessage }}
      </div>

      <div *ngIf="errorMessage" class="alert alert-danger mx-auto" style="max-width: 600px;" role="alert">
        {{ errorMessage }}
      </div>
      
      <!-- R√©sum√© des pr√©f√©rences -->
      <div class="bg-white rounded-3 p-3 d-inline-block shadow-sm mb-4" *ngIf="!errorMessage">
        <small class="text-muted">
          <strong>Vos crit√®res :</strong> 
          {{preferences.climat}} ‚Ä¢ {{getSelectedTypeVoyageName()}} ‚Ä¢ {{preferences.langueParlee}} ‚Ä¢ {{preferences.budget}} ‚Ä¢ {{preferences.activite}}
        </small>
      </div>
    </div>

    <!-- Spinner pour le chargement des recommandations -->
    <div *ngIf="isLoading" class="text-center mb-5">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Chargement des recommandations...</span>
      </div>
      <p class="mt-3">Recherche des meilleures destinations pour vous...</p>
    </div>

    <!-- Message si aucune recommandation -->
    <div *ngIf="!isLoading && recommendations.length === 0 && !errorMessage" class="text-center">
      <div class="alert alert-info" role="alert">
        <h4 class="alert-heading">Aucune recommandation trouv√©e</h4>
        <p>Nous n'avons pas trouv√© de destinations correspondant exactement √† vos crit√®res. Essayez de modifier vos pr√©f√©rences.</p>
        <hr>
        <p class="mb-0">
          <button class="btn btn-primary" (click)="goToPreferences()">
            Modifier mes pr√©f√©rences
          </button>
        </p>
      </div>
    </div>

    <!-- Liste des recommandations -->
    <div class="row g-4" *ngIf="!isLoading && recommendations.length > 0">
      <div *ngFor="let trip of recommendations; let i = index" class="col-lg-4 col-md-6">
        <div [ngClass]="getCardClass()" style="border-radius: 20px; overflow: hidden; position: relative">
          
          <!-- Badge de score (pour debug) -->
          <div class="position-absolute top-0 end-0 m-2" style="z-index: 10">
           <span class="badge bg-success">Score: {{ trip.score }}</span>
          </div>

          <!-- Header avec emoji -->
         <div class="card-header text-center p-4" style="background: linear-gradient(135deg, #0d6efd, #6610f2); color: white">
  <!-- üëâ Affiche la photo si dispo, sinon l‚Äôemoji -->
  <img *ngIf="trip.image" [src]="trip.image" class="img-fluid mb-3" 
       style="max-height: 200px; object-fit: cover; border-radius: 10px;" />
  <div *ngIf="!trip.image" style="font-size: 4rem">{{trip.image_placeholder}}</div>

  <h4 class="fw-bold mb-0">{{trip.destination}}</h4>
  <small class="opacity-75">{{trip.pays}}</small>
</div>


          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="badge bg-success px-3 py-2">{{trip.climat}}</span>
              <div class="d-flex align-items-center">
                <span *ngFor="let star of getStarArray(trip.rating)" class="text-warning">‚≠ê</span>
                <span class="fw-bold ms-1">{{trip.rating}}</span>
              </div>
            </div>

            <p class="text-muted mb-3">{{trip.description}}</p>

            <div class="mb-3" *ngIf="trip.highlights && trip.highlights.length > 0">
              <h6 class="fw-bold mb-2">Activit√©s disponibles :</h6>
              <div class="row g-1">
                <div *ngFor="let highlight of trip.highlights" class="col-6">
                  <small class="d-flex align-items-center">
                    ‚úÖ {{highlight}}
                  </small>
                </div>
              </div>
            </div>

            <div class="row text-center mb-3">
              <div class="col-6">
                <div class="border-end">
                  <h5 class="fw-bold mb-0" style="color: #0d6efd">{{trip.price}}</h5>
                  <small class="text-muted">Prix estim√©</small>
                </div>
              </div>
              <div class="col-6">
                <h5 class="fw-bold mb-0" style="color: #0d6efd">{{trip.duration}}</h5>
                <small class="text-muted">Dur√©e</small>
              </div>
            </div>

            <div class="mb-2">
              <small class="text-muted">
                <strong>Langue :</strong> {{trip.language}}
              </small>
            </div>
          </div>

          <div class="card-footer bg-transparent p-4">
            <div class="d-grid gap-2">
             <button 
              class="btn text-white fw-bold py-3"
              style="background-color: #0d6efd; border-radius: 15px; border: none"
              (click)="selectTrip(trip)"
            >
              Choisir ce voyage
            </button>
              <button class="btn btn-outline-secondary" (click)="addToFavorites(trip)">
                 Ajouter aux favoris
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-5">
      <button 
        class="btn btn-outline-primary btn-lg px-4"
        (click)="goToPreferences()"
      >
        ‚Üê Modifier mes pr√©f√©rences
      </button>
    </div>
  </div>
</div>
<!-- PAGE 3: BOOKING -->
<div *ngIf="currentPage === 'booking'" class="container-fluid min-vh-100">
  <app-booking 
    [selectedTrip]="selectedTrip"
    (goToRecommendations)="goToRecommendations()"
    (bookingCompleted)="onBookingCompleted()"
  ></app-booking>
</div>